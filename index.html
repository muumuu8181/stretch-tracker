
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ストレッチ管理</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- フィードバックシステム（開発改善用） -->
    <script src="feedback-system.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 2px; background: #f5f5f5; line-height: 1.2; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 6px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* スマホ対応 */
        @media (max-width: 768px) {
            body { padding: 3px; }
            .container { padding: 8px; margin: 0; border-radius: 0; }
            .weight-input { grid-template-columns: 1fr; gap: 8px; }
            .input-card { padding: 8px; }
        }
        .auth-section { background: #e7f3ff; color: #0c5460; padding: 6px; border-radius: 5px; margin-bottom: 6px; text-align: center; }
        .weight-input { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin: 8px 0; }
        .input-card { border: 1px solid #ddd; padding: 8px; border-radius: 8px; }
        
        /* タイミングパネルのスタイル */
        .timing-panel { 
            background: #f8f9fa; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            padding: 8px; 
            margin: 5px 0; 
        }
        .timing-buttons { 
            display: flex; 
            gap: 4px; 
            flex-wrap: wrap; 
            justify-content: center;
        }
        .timing-btn { 
            background: #6c757d; 
            color: white; 
            border: none; 
            padding: 6px 8px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 11px;
            transition: all 0.2s;
            min-width: 70px;
            text-align: center;
        }
        .timing-btn:hover {
            transform: scale(1.05);
        }
        .timing-btn.selected {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .timing-buttons { gap: 3px; }
            .timing-btn { 
                padding: 4px 6px; 
                font-size: 10px;
                min-width: 60px;
            }
        }
        .input-field { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 5px 0; font-size: 16px; }
        .save-button { background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin: 5px; font-size: 16px; }
        .save-button:hover { background: #218838; }
        .auth-button { background: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .auth-button:hover { background: #357ae8; }
        .logout-button { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .data-area { background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px; border-radius: 5px; font-family: monospace; min-height: 120px; }
        .hidden { display: none; }
        .user-info { background: #d4edda; color: #155724; padding: 4px 6px; border-radius: 5px; margin-bottom: 6px; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container" style="position: relative;">
        <span style="position: absolute; top: 10px; right: 10px; background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; z-index: 1000;">v0.2</span>
        <div class="app-header">
            <h1 class="app-title">🧘 ストレッチ管理</h1>
            <p class="app-subtitle">毎日のストレッチを記録・管理</p>
        </div>
        <!-- 認証セクション -->
        <div class="auth-section" id="authSection">
            <h3>🔐 ログイン</h3>
            <p>Googleアカウントでログインしてデータを保存・同期できます</p>
            <button class="auth-button" onclick="handleGoogleLogin()">Googleでログイン</button>
        </div>
        <!-- ユーザー情報表示 -->
        <div class="user-info hidden" id="userInfo">
            <span>👤 ログイン中: <span id="userName"></span></span>
            <button class="logout-button" onclick="handleLogout()">ログアウト</button>
        </div>

        <!-- ストレッチセクション -->
        <div class="stretch-section hidden" id="stretchSection">
            <div class="input-card">
                <h3 style="margin-top: 0; margin-bottom: 8px;">🏃 ストレッチメニュー</h3>
                <div class="stretch-buttons" id="stretchButtons" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin: 10px 0;">
                    <!-- ストレッチボタンはJavaScriptで追加 -->
                </div>
                
                <!-- タイマー表示エリア -->
                <div id="timer-display" style="display:none; text-align: center; padding: 20px; background: #f0f8ff; border-radius: 8px; margin-top: 10px;">
                    <h2 id="current-stretch" style="margin: 0 0 10px 0; color: #333;"></h2>
                    <div id="timer" style="font-size: 48px; font-weight: bold; color: #007bff; font-family: monospace;">00:00</div>
                    <button onclick="stopStretch()" style="background: #dc3545; color: white; border: none; padding: 10px 24px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-size: 16px;">⏹️ 停止</button>
                </div>
            </div>
            
            <div class="input-card">
                <h3>📊 今日の記録</h3>
                <div class="data-area" id="stretchHistory">
                    データを読み込み中...<br>
                </div>
            </div>
        </div>

        <!-- グラフパネル -->
        <div class="input-card hidden" id="chartPanel">
            <h3>📊 データ推移グラフ</h3>
            <div style="position: relative; height: 300px;">
                <canvas id="weightChart"></canvas>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                <button onclick="updateChartRange(1)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">1日</button>
                <button onclick="updateChartRange(7)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">1週間</button>
                <button onclick="updateChartRange(30)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">1ヶ月</button>
                <button onclick="updateChartRange(90)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">3ヶ月</button>
                <button onclick="updateChartRange(365)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">1年</button>
                <button onclick="updateChartRange(0)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">全期間</button>
            </div>
        </div>

        <h3>📋 アプリログ <button class="universal-copy-btn" onclick="copyLogs()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">📋 ログをコピー</button></h3>
        <div class="data-area" id="logArea">
            ストレッチ管理アプリ起動中...<br>
        </div>
        
        <!-- デバッグボタンエリア -->
        <div style="margin-top: 8px; text-align: center;">
            <button class="universal-copy-btn" onclick="debugFirebaseConnection()" style="background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🔍 Firebase Debug</button>
            <button class="universal-copy-btn" onclick="checkLoginIssues()" style="background: #ffc107; color: #212529; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">⚠️ ログイン問題診断</button>
            <button class="universal-copy-btn" onclick="copyDebugInfo()" style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">📋 デバッグ情報をコピー</button>
            <button class="universal-copy-btn" onclick="checkDatabaseStructure()" style="background: #6f42c1; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🏗️ DB構造確認</button>
            <button class="universal-copy-btn" onclick="checkMobileSupport()" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">📱 モバイル診断</button>
            <button class="universal-copy-btn" onclick="forceAuthCheck()" style="background: #fd7e14; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🔄 認証状態確認</button>
            <button class="universal-copy-btn" onclick="checkFirebaseConfig()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🔧 Firebase設定</button>
            <button class="universal-copy-btn" onclick="testPopup()" style="background: #20c997; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🧪 ポップアップテスト</button>
        </div>
    </div>

    <script>
        // エラーハンドリング用の安全なログ関数（構文エラーがあっても動作）
        window.safeLog = function(message) {
            try {
                const logArea = document.getElementById('logArea');
                if (logArea) {
                    const timestamp = new Date().toLocaleTimeString();
                    logArea.innerHTML += `[${timestamp}] ${message}<br>`;
                    logArea.scrollTop = logArea.scrollHeight;
                }
                console.log(message);
            } catch (e) {
                console.error('ログ出力エラー:', e);
            }
        };

        // グローバルエラーハンドラー（構文エラーも捕捉）
        window.addEventListener('error', function(event) {
            const errorMsg = `❌ エラー検出: ${event.message} (行: ${event.lineno})`;
            window.safeLog(errorMsg);
            return false;
        });

        // Core Firebase設定（変更禁止 - core/src/firebase-config.js参照）
        const firebaseConfig = {
            apiKey: "AIzaSyA5PXKChizYDCXF_GJ4KL6Ylq9K5hCPXWE",
            authDomain: "shares-b1b97.firebaseapp.com",
            databaseURL: "https://shares-b1b97-default-rtdb.firebaseio.com",
            projectId: "shares-b1b97",
            storageBucket: "shares-b1b97.firebasestorage.app",
            messagingSenderId: "38311063248",
            appId: "1:38311063248:web:0d2d5726d12b305b24b8d5"
        };

        // Firebase初期化
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let startTime;
        let timerInterval;
        let currentStretch;
        let stretchChart = null;
        let allStretchData = [];
        let selectedTimingValue = '';
        let weightChart = null;
        let allWeightData = [];
        window.editingEntryId = null;
        
        // 30種類のストレッチメニュー
        const stretchMenu = [
            '首回し', '肩回し', '前屈', '後屈', '側屈',
            '腕回し', '手首回し', '足首回し', '膝回し', '腰回し',
            'アキレス腱伸ばし', '太もも前側', '太もも裏側', 'ふくらはぎ', '股関節',
            '背中伸ばし', '胸開き', '肩甲骨はがし', '首筋伸ばし', '腕伸ばし',
            'ランジ', 'スクワット', '開脚', '腹筋', '背筋',
            'プランク', 'ブリッジ', '猫のポーズ', '子供のポーズ', '深呼吸'
        ];

        // ストレッチボタンを動的に生成
        function initializeStretchButtons() {
            const buttonsContainer = document.getElementById('stretchButtons');
            if (!buttonsContainer) return;
            
            buttonsContainer.innerHTML = stretchMenu.map(name => {
                const colors = [
                    '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
                    '#74B9FF', '#A29BFE', '#6C5CE7', '#FD79A8', '#FDCB6E',
                    '#00B894', '#00CEC9', '#0984E3', '#6C5CE7', '#E17055'
                ];
                const color = colors[Math.floor(Math.random() * colors.length)];
                return `<button onclick="startStretch('${name}')" style="background: ${color}; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">${name}</button>`;
            }).join('');
        }

        // ストレッチ開始
        window.startStretch = (name) => {
            currentStretch = name;
            startTime = Date.now();
            document.getElementById('current-stretch').textContent = name;
            document.getElementById('timer-display').style.display = 'block';

            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer').textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 100);
            
            log(`🏃 ストレッチ開始: ${name}`);
        };

        // ストレッチ停止
        window.stopStretch = async () => {
            clearInterval(timerInterval);
            const duration = Math.floor((Date.now() - startTime) / 1000);
            
            if (!currentUser) {
                log('❌ ログインが必要です');
                document.getElementById('timer-display').style.display = 'none';
                return;
            }
            
            await saveStretchRecord(currentStretch, duration);
            document.getElementById('timer-display').style.display = 'none';
            log(`⏹️ ストレッチ終了: ${currentStretch} (${duration}秒)`);
        };


        // ストレッチ記録を保存
        async function saveStretchRecord(name, duration) {
            try {
                const now = new Date();
                const stretchData = {
                    name: name,
                    duration: duration,
                    date: now.toISOString().split('T')[0],
                    time: now.toLocaleTimeString('ja-JP', { 
                        hour12: false, 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                const userRef = database.ref(`users/${currentUser.uid}/stretches`);
                await userRef.push(stretchData);
                log(`✅ 記録保存: ${name} - ${duration}秒`);
                
                // データを再読み込み
                loadUserStretchData(currentUser.uid);
            } catch (error) {
                log(`❌ 保存エラー: ${error.message}`);
            }
        }

        // 認証状態の監視（改良版）
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                log(`✅ 認証状態確認: ${user.displayName} でログイン中`);
                log(`📧 メール: ${user.email}`);
                showUserInterface(user);
                loadUserStretchData(user.uid);
                initializeStretchButtons();
            } else {
                log('🔒 認証状態: 未ログイン');
                showLoginInterface();
            }
        });

        // 初期化完了ログ
        log('🔄 Firebase認証システム初期化完了 - 認証状態を確認中...');

        // Googleログイン（改良版 - ポップアップブロック検知付き）
        window.handleGoogleLogin = async () => {
            try {
                log('🔐 Googleログイン開始...');
                const provider = new firebase.auth.GoogleAuthProvider();
                
                // モバイルデバイス検出（表示用）
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile) {
                    log('📱 モバイルデバイス検出 - ポップアップ方式でログイン');
                    log('💡 ポップアップが途中で止まる場合は、ブラウザ設定の確認が必要です');
                } else {
                    log('🖥️ デスクトップデバイス - ポップアップ方式でログイン');
                }
                
                // ポップアップブロック検知のためのタイムアウト設定
                log('🪟 ポップアップウィンドウでGoogleログインを開始...');
                
                const loginPromise = auth.signInWithPopup(provider);
                
                // タイムアウト検知（5秒でポップアップが開かない場合）
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => {
                        reject(new Error('ポップアップタイムアウト - ブロックされた可能性があります'));
                    }, 5000);
                });
                
                try {
                    const result = await Promise.race([loginPromise, timeoutPromise]);
                    log(`✅ ログイン成功: ${result.user.displayName}`);
                } catch (raceError) {
                    // タイムアウトの場合の特別処理
                    if (raceError.message.includes('タイムアウト')) {
                        log('⏰ ポップアップが5秒以内に開きませんでした');
                        log('🔄 ポップアップブロック検知 - 解決方法をご案内します');
                        throw new Error('POPUP_TIMEOUT');
                    } else {
                        throw raceError;
                    }
                }
                
            } catch (error) {
                log(`❌ ログインエラー: ${error.message}`);
                
                // モバイルデバイス検出（エラー処理用）
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                // エラーの詳細情報をログに出力
                if (error.code) {
                    log(`- エラーコード: ${error.code}`);
                    
                    // 特定のエラーコードに対する解決策を提示
                    switch(error.code) {
                        case 'auth/unauthorized-domain':
                            log('💡 ドメイン許可設定の問題です');
                            log('💡 Firebase Consoleで認証ドメインを確認してください');
                            break;
                        case 'auth/popup-blocked':
                            log('💡 ポップアップがブロックされました');
                            showPopupGuide(isMobile);
                            break;
                        case 'auth/popup-closed-by-user':
                            log('💡 ユーザーがポップアップを閉じました');
                            log('💡 もう一度ログインボタンを押してください');
                            break;
                        case 'auth/cancelled-popup-request':
                            log('💡 前回のポップアップがキャンセルされました');
                            log('💡 しばらく待ってから再試行してください');
                            break;
                        default:
                            if (error.message === 'POPUP_TIMEOUT') {
                                log('⚠️ ポップアップが途中で止まりました');
                                showPopupGuide(isMobile);
                            } else {
                                log('💡 ブラウザを更新してもう一度お試しください');
                            }
                    }
                } else if (error.message === 'POPUP_TIMEOUT') {
                    showPopupGuide(isMobile);
                }
                
                if (error.credential) {
                    log('- 認証情報は取得済み');
                }
            }
        };

        // ポップアップ許可ガイド表示
        function showPopupGuide(isMobile) {
            log('📖 === ポップアップ許可ガイド ===');
            if (isMobile) {
                log('📱 スマートフォン向け解決手順:');
                log('1. ページ上部のアドレスバーに表示される「ポップアップがブロックされました」をタップ');
                log('2. または、ブラウザメニュー(⋮) → 設定 → サイト設定 → ポップアップとリダイレクト → 許可');
                log('3. Chrome: 右上⋮メニュー → 設定 → 詳細設定 → サイト設定 → ポップアップとリダイレクト');
                log('4. Safari: 設定アプリ → Safari → ポップアップブロック → オフ');
                log('5. 設定後、このページを更新してもう一度ログインボタンを押してください');
            } else {
                log('💻 PC向け解決手順:');
                log('1. アドレスバー右端のアイコン(🚫)をクリック → 許可');
                log('2. または、ブラウザ設定 → プライバシーとセキュリティ → ポップアップとリダイレクト → 許可');
            }
            log('💡 それでも解決しない場合: プライベートモードを終了するか、別のブラウザをお試しください');
            log('🔄 ポップアップ設定を確認したら、再度「Googleでログイン」ボタンを押してください');
            log('📖 ========================');
        }

        // ポップアップテスト機能
        window.testPopup = () => {
            log('🧪 ポップアップテスト開始...');
            
            try {
                const testWindow = window.open('', '_blank', 'width=400,height=500');
                
                if (testWindow) {
                    log('✅ ポップアップ許可済み - ログイン可能です');
                    testWindow.close();
                    log('💡 「Googleでログイン」ボタンを押してください');
                } else {
                    log('❌ ポップアップがブロックされています');
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    showPopupGuide(isMobile);
                }
            } catch (error) {
                log(`❌ ポップアップテストエラー: ${error.message}`);
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                showPopupGuide(isMobile);
            }
        };

        // ログアウト
        window.handleLogout = async () => {
            try {
                await auth.signOut();
                log('📤 ログアウト完了');
            } catch (error) {
                log(`❌ ログアウトエラー: ${error.message}`);
            }
        };

        // ユーザーのストレッチデータを読み込み
        function loadUserStretchData(userId) {
            const userRef = database.ref(`users/${userId}/stretches`);
            const today = new Date().toISOString().split('T')[0];
            
            userRef.orderByChild('date').equalTo(today).on('value', (snapshot) => {
                const data = snapshot.val();
                const historyDiv = document.getElementById('stretchHistory');
                
                if (data) {
                    const entries = Object.entries(data)
                        .map(([key, value]) => ({ id: key, ...value }))
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    let totalDuration = 0;
                    const stretchCounts = {};
                    
                    entries.forEach(entry => {
                        totalDuration += entry.duration;
                        stretchCounts[entry.name] = (stretchCounts[entry.name] || 0) + 1;
                    });
                    
                    const totalMinutes = Math.floor(totalDuration / 60);
                    const totalSeconds = totalDuration % 60;
                    
                    historyDiv.innerHTML = `
                        <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                            <strong>今日の合計: ${totalMinutes}分${totalSeconds}秒</strong><br>
                            <small>実施種目: ${Object.keys(stretchCounts).length}種類</small>
                        </div>
                        ${entries.map(entry => {
                            const minutes = Math.floor(entry.duration / 60);
                            const seconds = entry.duration % 60;
                            return `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">
                                ${entry.time} - ${entry.name}: ${minutes}分${seconds}秒
                            </div>`;
                        }).join('')}
                    `;
                    
                    log(`📊 今日の記録読み込み完了: ${entries.length}件`);
                } else {
                    historyDiv.innerHTML = '今日のストレッチ記録はまだありません';
                    log('📊 今日の記録: データなし');
                }
            });
        }

        // データ保存（使わないが残しておく）
        window.saveWeightData = async () => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }

            const date = document.getElementById('dateInput').value;
            const weight = document.getElementById('weightValue').value;
            const memo = document.getElementById('memoInput').value;

            if (!date || !weight) {
                log('❌ 日付と値を入力してください');
                return;
            }

            try {
                log('💾 データを保存中...');
                
                const now = new Date();
                const timeString = now.toLocaleTimeString('ja-JP', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const weightData = {
                    date: date,
                    time: timeString,
                    value: parseFloat(weight),
                    timing: selectedTimingValue || '',
                    memo: memo || '',
                    userEmail: currentUser.email,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    createdAt: now.toISOString()
                };

                if (window.editingEntryId) {
                    // 編集モード: 既存データを更新
                    const entryRef = database.ref(`users/${currentUser.uid}/weights/${window.editingEntryId}`);
                    await entryRef.update({
                        date: date,
                        time: timeString,
                        weight: parseFloat(weight),
                        timing: selectedTimingValue || '',
                        clothing: {
                            top: selectedTopValue || '',
                            bottom: selectedBottomValue || ''
                        },
                        memo: memo || '',
                        userEmail: currentUser.email,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                } else {
                    // 新規保存モード
                    const userRef = database.ref(`users/${currentUser.uid}/weights`);
                    await userRef.push(weightData);
                }
                
                // 保存完了ログ（服装情報も含む）
                let logMessage;
                if (window.editingEntryId) {
                    logMessage = `✏️ 更新完了: ${date} ${timeString} - ${weight}kg`;
                } else {
                    logMessage = `✅ 保存完了: ${date} ${timeString} - ${weight}kg`;
                }
                if (selectedTimingValue) logMessage += ` (${selectedTimingValue})`;
                if (selectedTopValue || selectedBottomValue) {
                    const clothingInfo = [selectedTopValue, selectedBottomValue].filter(Boolean).join(', ');
                    logMessage += ` [${clothingInfo}]`;
                }
                log(logMessage);
                
                // 入力フィールドをクリア（体重は72.0に戻す）
                document.getElementById('weightValue').value = '0.0';
                document.getElementById('memoInput').value = '';
                document.getElementById('selectedTop').value = '';
                document.getElementById('selectedBottom').value = '';
                selectedTimingValue = '';
                selectedTopValue = '';
                selectedBottomValue = '';
                
                // 編集モードをリセット
                window.editingEntryId = null;
                document.querySelector('.save-button').textContent = '💾 保存';
                document.querySelector('.save-button').style.background = '#28a745';
                
                // ボタンのスタイルをリセット
                document.querySelectorAll('.timing-btn').forEach(btn => {
                    btn.style.opacity = '0.7';
                    btn.classList.remove('selected');
                });
                document.querySelectorAll('.clothing-btn').forEach(btn => {
                    btn.style.opacity = '0.7';
                    btn.style.transform = 'scale(1)';
                });
                
                // データを再読み込み
                loadUserWeightData(currentUser.uid);
            } catch (error) {
                log(`❌ 保存エラー: ${error.message}`);
            }
        };

        // 体重データ編集機能
        window.editWeightEntry = async (entryId) => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }
            
            try {
                const entryRef = database.ref(`users/${currentUser.uid}/weights/${entryId}`);
                const snapshot = await entryRef.once('value');
                const entry = snapshot.val();
                
                if (!entry) {
                    log('❌ 記録が見つかりません');
                    return;
                }
                
                // フォームにデータを設定
                document.getElementById('dateInput').value = entry.date;
                document.getElementById('weightValue').value = entry.value || entry.weight;
                document.getElementById('memoInput').value = entry.memo || '';
                
                // タイミングを設定
                if (entry.timing) {
                    selectTiming(entry.timing);
                }
                
                
                // 編集モードに切り替え
                window.editingEntryId = entryId;
                document.querySelector('.save-button').textContent = '✏️ 更新';
                document.querySelector('.save-button').style.background = '#ffc107';
                
                log(`✏️ 編集モード: ${entry.date} ${entry.value || entry.weight} のデータを編集中`);
                
                // ページトップにスクロール
                window.scrollTo(0, 0);
                
            } catch (error) {
                log(`❌ 編集エラー: ${error.message}`);
            }
        };
        
        // データ削除
        window.deleteWeightEntry = async (entryId) => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }
            
            if (!confirm('この記録を削除しますか？')) {
                return;
            }
            
            try {
                log(`🗑️ データ削除中: ${entryId}`);
                const entryRef = database.ref(`users/${currentUser.uid}/weights/${entryId}`);
                await entryRef.remove();
                log(`✅ 削除完了: ${entryId}`);
            } catch (error) {
                log(`❌ 削除エラー: ${error.message}`);
            }
        };

        // ユーザーのデータを読み込み
        function loadUserWeightData(userId) {
            const userRef = database.ref(`users/${userId}/weights`);
            userRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const historyDiv = document.getElementById('weightHistory');
                
                if (data) {
                    const entries = Object.entries(data)
                        .map(([key, value]) => ({ id: key, ...value }))
                        .sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
                    
                    // グラフ用にデータを保存
                    allWeightData = entries.sort((a, b) => new Date(a.date) - new Date(b.date));
                    updateChart();
                    
                    historyDiv.innerHTML = entries.map(entry => {
                        let displayText = `${entry.date}`;
                        if (entry.time) displayText += ` ${entry.time}`;
                        displayText += `: ${entry.value || entry.weight}`;
                        if (entry.timing) displayText += ` (${entry.timing})`;
                        
                        
                        if (entry.memo) displayText += ` - ${entry.memo}`;
                        return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 2px 0; border-bottom: 1px solid #eee;"><span>${displayText}</span><div style="display: flex; gap: 2px;"><button onclick="editWeightEntry('${entry.id}')" style="background: #007bff; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">✏️</button><button onclick="deleteWeightEntry('${entry.id}')" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">🗑️</button></div></div>`;
                    }).join('');
                    
                    log(`📈 データ履歴読み込み完了: ${entries.length}件`);
                } else {
                    historyDiv.innerHTML = 'まだデータがありません';
                    log('📈 データ履歴: データなし');
                    allWeightData = [];
                    updateChart();
                }
            });
        }

        // グラフを更新
        function updateChart(days = 30) {
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;

            const now = new Date();
            const startDate = new Date(now);
            if (days > 0) {
                startDate.setDate(now.getDate() - days);
            } else {
                // 全期間の場合、最も古いデータから
                if (allWeightData.length > 0) {
                    startDate.setTime(new Date(allWeightData[0].date).getTime());
                }
            }

            // 期間内のデータをフィルタリング
            const filteredData = allWeightData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= now;
            });

            // 日付でグループ化（同じ日の複数記録がある場合は平均を取る）
            const groupedData = {};
            filteredData.forEach(entry => {
                if (!groupedData[entry.date]) {
                    groupedData[entry.date] = [];
                }
                groupedData[entry.date].push(entry.value || entry.weight);
            });

            // グラフ用データを準備
            const chartData = Object.keys(groupedData).sort().map(date => ({
                x: date,
                y: groupedData[date].reduce((a, b) => a + b, 0) / groupedData[date].length
            }));

            // グラフを描画
            if (weightChart) {
                weightChart.destroy();
            }

            const chartConfig = {
                type: 'line',
                data: {
                    datasets: [{
                        label: '値',
                        data: chartData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `値: ${context.parsed.y.toFixed(1)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MM/dd'
                                }
                            },
                            title: {
                                display: true,
                                text: '日付'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '値'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        }
                    }
                }
            };

            weightChart = new Chart(ctx, chartConfig);
            log(`📊 グラフ更新: ${chartData.length}件のデータ表示`);
        }

        // グラフの表示期間を変更
        window.updateChartRange = (days) => {
            updateChart(days);
            const rangeName = days === 1 ? '1日' :
                            days === 7 ? '1週間' : 
                            days === 30 ? '1ヶ月' : 
                            days === 90 ? '3ヶ月' : 
                            days === 365 ? '1年' : '全期間';
            log(`📊 グラフ表示期間変更: ${rangeName}`);
        }

        // UI表示制御
        function showUserInterface(user) {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('stretchSection').classList.remove('hidden');
            document.getElementById('chartPanel').classList.add('hidden');
            document.getElementById('userName').textContent = user.displayName;
            
        }

        function showLoginInterface() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('stretchSection').classList.add('hidden');
            document.getElementById('chartPanel').classList.add('hidden');
        }

        // ログ出力関数
        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}<br>`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }

        // ログコピー機能
        window.copyLogs = () => {
            const logArea = document.getElementById('logArea');
            const logText = logArea.innerText || logArea.textContent;
            navigator.clipboard.writeText(logText).then(() => {
                alert('✅ ログをコピーしました');
            }).catch(() => {
                // fallback
                const textArea = document.createElement('textarea');
                textArea.value = logText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('✅ ログをコピーしました');
            });
        };

        // Firebase接続デバッグ
        window.debugFirebaseConnection = () => {
            log('🔍 === Firebase Debug 開始 ===');
            
            // 1. Firebase設定確認
            log(`🔥 Firebase Config確認:`);
            log(`- Project ID: ${firebaseConfig.projectId}`);
            log(`- Database URL: ${firebaseConfig.databaseURL}`);
            log(`- Auth Domain: ${firebaseConfig.authDomain}`);
            
            // 2. 認証状態確認
            if (currentUser) {
                log(`✅ 認証済みユーザー:`);
                log(`- UID: ${currentUser.uid.substring(0,8)}...`);
                log(`- Email: ${currentUser.email}`);
                log(`- 表示名: ${currentUser.displayName}`);
            } else {
                log('❌ 未認証状態');
            }
            
            // 3. 接続テスト
            const connectedRef = database.ref('.info/connected');
            connectedRef.once('value', (snapshot) => {
                const connected = snapshot.val();
                log(`🌐 Firebase接続状態: ${connected ? '接続中' : '未接続'}`);
                
                if (connected && currentUser) {
                    // データベーステスト
                    const testRef = database.ref(`users/${currentUser.uid}/test`);
                    testRef.set({
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        message: 'Connection test',
                        app: 'app-template'
                    }).then(() => {
                        log('✅ データベース書き込みテスト成功');
                    }).catch((error) => {
                        log(`❌ データベース書き込みエラー: ${error.message}`);
                        log(`- Error Code: ${error.code}`);
                    });
                }
            });
            
            log('🔍 === Firebase Debug 完了 ===');
        };

        // モバイル環境診断
        window.checkMobileSupport = () => {
            log('📱 === モバイル環境診断 開始 ===');
            
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            
            log(`🌐 ユーザーエージェント: ${userAgent}`);
            log(`📱 モバイルデバイス判定: ${isMobile ? 'モバイル' : 'デスクトップ'}`);
            
            // ブラウザ判定
            const isChrome = /Chrome/i.test(userAgent);
            const isSafari = /Safari/i.test(userAgent) && !/Chrome/i.test(userAgent);
            const isFirefox = /Firefox/i.test(userAgent);
            
            log(`🌐 ブラウザ: ${isChrome ? 'Chrome' : isSafari ? 'Safari' : isFirefox ? 'Firefox' : '不明'}`);
            
            // ログイン方式の推奨
            if (isMobile) {
                log('💡 モバイルの推奨設定:');
                log('- Googleログインはリダイレクト方式を使用');
                log('- ポップアップブロッカーの影響なし');
                log('- 認証後にページが再読み込みされます');
            }
            
            log('📱 === モバイル環境診断 完了 ===');
        };

        // Firebase設定診断
        window.checkFirebaseConfig = () => {
            log('🔧 === Firebase設定診断 開始 ===');
            
            // 現在のドメイン確認
            const currentDomain = window.location.hostname;
            const currentUrl = window.location.href;
            log(`🌐 現在のドメイン: ${currentDomain}`);
            log(`🔗 現在のURL: ${currentUrl}`);
            
            // Firebase設定情報
            log(`🔥 Firebase設定:`);
            log(`- Project ID: ${firebaseConfig.projectId}`);
            log(`- Auth Domain: ${firebaseConfig.authDomain}`);
            log(`- Database URL: ${firebaseConfig.databaseURL}`);
            
            // 認証ドメイン許可状況の推測
            if (currentDomain === 'muumuu8181.github.io') {
                log('✅ GitHub Pagesドメイン検出');
                log('💡 Firebase Consoleでこのドメインが許可されているか確認が必要');
            } else if (currentDomain === 'localhost' || currentDomain === '127.0.0.1') {
                log('✅ ローカルホスト検出');
                log('💡 通常は自動で許可されています');
            } else {
                log('⚠️ 不明なドメインです');
                log('💡 Firebase Consoleの認証設定で許可が必要かもしれません');
            }
            
            // モバイルブラウザでのリダイレクト制限確認
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            
            if (isMobile) {
                log('📱 モバイルブラウザ固有の制限:');
                log('- Safari: サードパーティCookieの制限あり');
                log('- Chrome Mobile: ポップアップの自動ブロック');
                log('- 解決策: リダイレクト方式またはポップアップ許可設定');
            }
            
            log('🔧 === Firebase設定診断 完了 ===');
        };

        // 認証状態の強制確認
        window.forceAuthCheck = () => {
            log('🔍 === 認証状態強制確認 開始 ===');
            
            const user = auth.currentUser;
            log(`🔐 Firebase認証状態: ${user ? `ログイン済み (${user.displayName})` : '未ログイン'}`);
            
            if (user) {
                log('✅ ユーザー画面を表示します');
                showUserInterface(user);
                loadUserWeightData(user.uid);
            } else {
                log('❌ ログイン画面を表示します');
                showLoginInterface();
            }
            
            // 認証トークンの有効性確認
            if (user) {
                user.getIdToken(true).then(() => {
                    log('✅ 認証トークンは有効です');
                }).catch((tokenError) => {
                    log(`❌ 認証トークンエラー: ${tokenError.message}`);
                    log('💡 再ログインが必要かもしれません');
                });
            }
            
            log('🔍 === 認証状態強制確認 完了 ===');
        };

        // ログイン問題診断
        window.checkLoginIssues = () => {
            log('⚠️ === ログイン問題診断 開始 ===');
            
            // 1. プロトコルチェック
            const protocol = window.location.protocol;
            log(`🌐 現在のプロトコル: ${protocol}`);
            
            if (protocol === 'file:') {
                log('❌ 問題発見: file://プロトコルではGoogle認証が動作しません');
                log('✅ 解決方法:');
                log('  1. HTTPサーバー経由でアクセス');
                log('  2. chrome://flags で insecure origins を許可');
                log('  3. ローカルサーバー起動 (python -m http.server 8000)');
            } else if (protocol === 'https:' || protocol === 'http:') {
                log('✅ プロトコル: 問題なし');
            }
            
            // 2. Web Storage確認
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                log('✅ Web Storage: 利用可能');
            } catch (e) {
                log('❌ Web Storage: 無効');
                log('✅ 解決方法: ブラウザ設定でCookieを有効にしてください');
            }
            
            // 3. Firebaseライブラリ確認
            if (typeof firebase !== 'undefined') {
                log('✅ Firebase SDK: 読み込み済み');
                log(`- Firebase Version: ${firebase.SDK_VERSION || 'Unknown'}`);
            } else {
                log('❌ Firebase SDK: 読み込みエラー');
            }
            
            // 4. ドメイン確認
            const domain = window.location.hostname;
            log(`🏠 現在のドメイン: ${domain}`);
            
            if (domain === 'localhost' || domain === '127.0.0.1') {
                log('✅ ローカル開発: Firebase設定で許可が必要');
            }
            
            log('⚠️ === ログイン問題診断 完了 ===');
        };

        // データベース構造確認
        window.checkDatabaseStructure = async () => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }
            
            log('🏗️ === データベース構造確認 開始 ===');
            
            try {
                // 現在のユーザーのweightsデータ構造を確認
                const userRef = database.ref(`users/${currentUser.uid}/weights`);
                const snapshot = await userRef.once('value');
                const data = snapshot.val();
                
                if (data) {
                    const entries = Object.keys(data);
                    log(`📊 現在のユーザー(${currentUser.email})のデータ:`);
                    log(`- データ記録数: ${entries.length}件`);
                    log(`- 最新記録ID: ${entries[entries.length - 1]}`);
                    
                    // サンプルデータ構造を表示
                    const sampleEntry = data[entries[0]];
                    log(`- データ構造: ${JSON.stringify(sampleEntry, null, 2)}`);
                } else {
                    log('📊 現在のユーザーにはデータがありません');
                }
                
                // ルートレベルの構造確認（管理者権限が必要）
                try {
                    const rootRef = database.ref('users');
                    const rootSnapshot = await rootRef.once('value');
                    const allUsers = rootSnapshot.val();
                    
                    if (allUsers) {
                        const userCount = Object.keys(allUsers).length;
                        log(`👥 全体統計:`);
                        log(`- 登録ユーザー数: ${userCount}人`);
                        
                        let totalWeights = 0;
                        Object.values(allUsers).forEach(user => {
                            if (user.weights) {
                                totalWeights += Object.keys(user.weights).length;
                            }
                        });
                        log(`- 全体の体重記録数: ${totalWeights}件`);
                    }
                } catch (error) {
                    log(`⚠️ 全体統計の取得に制限があります: ${error.message}`);
                }
                
            } catch (error) {
                log(`❌ 構造確認エラー: ${error.message}`);
            }
            
            log('🏗️ === データベース構造確認 完了 ===');
        };

        // デバッグ情報をコピー
        window.copyDebugInfo = () => {
            const debugInfo = `体重管理アプリ デバッグ情報
=================================
タイムスタンプ: ${new Date().toLocaleString()}
URL: ${window.location.href}
プロトコル: ${window.location.protocol}
ドメイン: ${window.location.hostname}
ユーザーエージェント: ${navigator.userAgent}

Firebase設定:
- プロジェクトID: ${firebaseConfig.projectId}
- データベースURL: ${firebaseConfig.databaseURL}
- 認証ドメイン: ${firebaseConfig.authDomain}

認証状態: ${currentUser ? 'ログイン済み' : '未ログイン'}
${currentUser ? `- UID: ${currentUser.uid.substring(0,8)}...\n- Email: ${currentUser.email}\n- 表示名: ${currentUser.displayName}` : ''}

Firebase SDK: ${typeof firebase !== 'undefined' ? '読み込み済み' : '読み込みエラー'}
Web Storage: ${(() => {
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        return '利用可能';
    } catch (e) {
        return '無効';
    }
})()}

ログ内容:
${document.getElementById('logArea').innerText}`;

            navigator.clipboard.writeText(debugInfo).then(() => {
                alert('✅ デバッグ情報をコピーしました');
            }).catch(() => {
                // fallback
                const textArea = document.createElement('textarea');
                textArea.value = debugInfo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('✅ デバッグ情報をコピーしました');
            });
        };

        // 初期化（エラーに強い初期化処理）
        try {
            log('🚀 ストレッチ管理アプリ起動完了');
            log('🔐 認証システム準備完了');
            
            // 重要な関数の存在チェック
            if (typeof handleGoogleLogin === 'undefined') {
                window.safeLog('⚠️ 警告: ログイン関数が定義されていません');
            }
            if (typeof startStretch === 'undefined') {
                window.safeLog('⚠️ 警告: ストレッチ開始関数が定義されていません');
            }
        } catch (initError) {
            window.safeLog(`❌ 初期化エラー: ${initError.message}`);
        }
        
        // プロトコルチェック（自動診断）
        if (window.location.protocol === 'file:') {
            log('⚠️ file://プロトコル検出 - Googleログインには HTTPサーバーが必要です');
            log('💡 解決方法: python -m http.server 8000 または chrome://flags設定');
        }
    </script>
</body>
</html>
